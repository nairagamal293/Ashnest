<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المسؤول - متجر الكترونى</title>
    
    <!-- Bootstrap 5 RTL CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Google Fonts - Tajawal & Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Cairo:wght@600;700;800&display=swap" rel="stylesheet">
    
    <link href="css/admin.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
 <style>
    /* Product Images Styles */
.product-images-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.product-image-item {
    position: relative;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    background-color: #f8f9fa;
    transition: transform 0.2s, box-shadow 0.2s;
}

.product-image-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.product-image-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    display: block;
}

.image-actions {
    padding: 8px;
    background-color: #fff;
    border-top: 1px solid #eee;
}

.image-checkbox {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    font-size: 12px;
}

.image-checkbox:last-child {
    margin-bottom: 0;
}

.image-checkbox input {
    margin-right: 5px;
}

.image-checkbox label {
    cursor: pointer;
    margin: 0;
}

.image-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: rgba(0, 123, 255, 0.8);
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: bold;
}

.image-remove {
    position: absolute;
    top: 5px;
    left: 5px;
    background-color: rgba(220, 53, 69, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    transition: background-color 0.2s;
}

.image-remove:hover {
    background-color: rgba(220, 53, 69, 1);
}

.no-images-message {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    font-style: italic;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px dashed #dee2e6;
}

.image-upload-area {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    background-color: #f8f9fa;
    transition: border-color 0.2s, background-color 0.2s;
}

.image-upload-area:hover {
    border-color: #007bff;
    background-color: #f0f7ff;
}
 </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="sidebar-logo">
                <i class="bi bi-house-gear-fill"></i>
                <span>Ashnest</span>
            </a>
        </div>
        <div class="sidebar-menu">
            <a href="#" class="sidebar-item active" data-page="dashboard">
                <i class="bi bi-speedometer2"></i>
                <span>لوحة التحكم</span>
            </a>
            <a href="#" class="sidebar-item" data-page="products">
                <i class="bi bi-box-seam"></i>
                <span>المنتجات</span>
            </a>
            <a href="#" class="sidebar-item" data-page="categories">
                <i class="bi bi-tags"></i>
                <span>الأقسام</span>
            </a>
            <a href="#" class="sidebar-item" data-page="discounts">
                <i class="bi bi-percent"></i>
                <span>الخصومات</span>
            </a>
            <a href="#" class="sidebar-item" data-page="orders">
                <i class="bi bi-bag-check"></i>
                <span>الطلبات</span>
            </a>
            <a href="#" class="sidebar-item" data-page="coupons">
                <i class="bi bi-ticket-perforated"></i>
                <span>الكوبونات</span>
            </a>
            <a href="#" class="sidebar-item" data-page="users">
                <i class="bi bi-people"></i>
                <span>المستخدمون</span>
            </a>
            <a href="#" class="sidebar-item" data-page="reports">
                <i class="bi bi-graph-up"></i>
                <span>التقارير</span>
            </a>
            <a href="#" class="sidebar-item" id="logoutBtn">
                <i class="bi bi-box-arrow-left"></i>
                <span>تسجيل خروج</span>
            </a>
        </div>
    </nav>
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-left">
                <button class="menu-toggle" id="menuToggle">
                    <i class="bi bi-list"></i>
                </button>
                <h1 class="page-title" id="pageTitle">لوحة التحكم</h1>
            </div>
            <div class="top-bar-right">
                <div class="user-dropdown">
                    <img src="https://ui-avatars.com/api/?name=مدير&background=1a365d&color=fff" alt="User" class="user-avatar" id="userAvatar">
                </div>
            </div>
        </div>
        <!-- Page Content -->
        <div id="pageContent">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-content">
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="stats-card primary">
                            <i class="bi bi-box-seam stats-icon"></i>
                            <div class="stats-content">
                                <div class="stats-title">إجمالي المنتجات</div>
                                <div class="stats-value" id="totalProducts">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="stats-card success">
                            <i class="bi bi-bag-check stats-icon"></i>
                            <div class="stats-content">
                                <div class="stats-title">الطلبات الجديدة</div>
                                <div class="stats-value" id="newOrders">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="stats-card warning">
                            <i class="bi bi-people stats-icon"></i>
                            <div class="stats-content">
                                <div class="stats-title">المستخدمون الجدد</div>
                                <div class="stats-value" id="newUsers">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="stats-card danger">
                            <i class="bi bi-graph-up stats-icon"></i>
                            <div class="stats-content">
                                <div class="stats-title">إجمالي المبيعات</div>
                                <div class="stats-value" id="totalSales">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">مبيعات الشهر</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="salesChart" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">المنتجات الأكثر مبيعاً</h5>
                            </div>
                            <div class="card-body">
                                <div id="topProducts">
                                    <div class="spinner-container">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">جاري التحميل...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">الطلبات الأخيرة</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>رقم الطلب</th>
                                                <th>العميل</th>
                                                <th>التاريخ</th>
                                                <th>الحالة</th>
                                                <th>الإجمالي</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentOrders">
                                            <tr>
                                                <td colspan="5" class="text-center py-3">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">جاري التحميل...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">المستخدمون النشطون</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>الاسم</th>
                                                <th>البريد الإلكتروني</th>
                                                <th>الطلبات</th>
                                                <th>الإنفاق</th>
                                            </tr>
                                        </thead>
                                        <tbody id="activeUsers">
                                            <tr>
                                                <td colspan="4" class="text-center py-3">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">جاري التحميل...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Products Page -->
            <div id="productsPage" class="page-content" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">إدارة المنتجات</h5>
                        <button class="btn btn-primary btn-sm" id="addProductBtn">
                            <i class="bi bi-plus-circle me-1"></i> إضافة منتج
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="ابحث عن منتج..." id="productSearch">
                                    <button class="btn btn-outline-secondary" type="button" id="searchProductBtn">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="categoryFilter">
                                    <option value="">جميع الأقسام</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter">
                                    <option value="">جميع الحالات</option>
                                    <option value="Active">نشط</option>
                                    <option value="Inactive">غير نشط</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>الصورة</th>
                                        <th>الاسم</th>
                                        <th>القسم</th>
                                        <th>السعر</th>
                                        <th>السعر بعد الخصم</th>
                                        <th>المخزون</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTable">
                                    <tr>
                                        <td colspan="8" class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">جاري التحميل...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Categories Page -->
            <div id="categoriesPage" class="page-content" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">إدارة الأقسام</h5>
                        <button class="btn btn-primary btn-sm" id="addCategoryBtn">
                            <i class="bi bi-plus-circle me-1"></i> إضافة قسم
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>الصورة</th>
                                        <th>الاسم</th>
                                        <th>الوصف</th>
                                        <th>القسم الأصل</th>
                                        <th>الخصم</th>
                                        <th>المنتجات</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="categoriesTable">
                                    <tr>
                                        <td colspan="7" class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">جاري التحميل...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Discounts Page -->
            <div id="discountsPage" class="page-content" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">إدارة الخصومات</h5>
                        <button class="btn btn-primary btn-sm" id="addDiscountBtn">
                            <i class="bi bi-plus-circle me-1"></i> إضافة خصم
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select class="form-select" id="discountTypeFilter">
                                    <option value="">جميع الأنواع</option>
                                    <option value="product">خصم على منتج</option>
                                    <option value="category">خصم على قسم</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="discountStatusFilter">
                                    <option value="">جميع الحالات</option>
                                    <option value="true">نشط</option>
                                    <option value="false">غير نشط</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="ابحث عن خصم..." id="discountSearch">
                                    <button class="btn btn-outline-secondary" type="button" id="searchDiscountBtn">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th>النوع</th>
                                        <th>المنتج/القسم</th>
                                        <th>نسبة الخصم</th>
                                        <th>تاريخ البدء</th>
                                        <th>تاريخ الانتهاء</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="discountsTable">
                                    <tr>
                                        <td colspan="8" class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">جاري التحميل...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Orders Page -->
            <div id="ordersPage" class="page-content" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">إدارة الطلبات</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="ابحث عن طلب..." id="orderSearch">
                                    <button class="btn btn-outline-secondary" type="button" id="searchOrderBtn">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="orderStatusFilter">
                                    <option value="">جميع الحالات</option>
                                    <option value="Pending">قيد الانتظار</option>
                                    <option value="Processing">قيد المعالجة</option>
                                    <option value="Shipped">تم الشحن</option>
                                    <option value="Delivered">تم التسليم</option>
                                    <option value="Cancelled">ملغي</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="orderDateFilter">
                                    <option value="">جميع التواريخ</option>
                                    <option value="today">اليوم</option>
                                    <option value="week">هذا الأسبوع</option>
                                    <option value="month">هذا الشهر</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>رقم الطلب</th>
                                        <th>العميل</th>
                                        <th>التاريخ</th>
                                        <th>الإجمالي</th>
                                        <th>الخصم</th>
                                        <th>الإجمالي النهائي</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTable">
                                    <tr>
                                        <td colspan="8" class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">جاري التحميل...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Coupons Page -->
            <div id="couponsPage" class="page-content" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">إدارة الكوبونات</h5>
                        <button class="btn btn-primary btn-sm" id="addCouponBtn">
                            <i class="bi bi-plus-circle me-1"></i> إضافة كوبون
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>الكود</th>
                                        <th>نسبة الخصم</th>
                                        <th>تاريخ الانتهاء</th>
                                        <th>الحد الأقصى</th>
                                        <th>المستخدم</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="couponsTable">
                                    <tr>
                                        <td colspan="7" class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">جاري التحميل...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Users Page -->
            <div id="usersPage" class="page-content" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">إدارة المستخدمين</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="ابحث عن مستخدم..." id="userSearch">
                                    <button class="btn btn-outline-secondary" type="button" id="searchUserBtn">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="userRoleFilter">
                                    <option value="">جميع الأدوار</option>
                                    <option value="Customer">عميل</option>
                                    <option value="Admin">مدير</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="userDateFilter">
                                    <option value="">جميع التواريخ</option>
                                    <option value="today">اليوم</option>
                                    <option value="week">هذا الأسبوع</option>
                                    <option value="month">هذا الشهر</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>الهاتف</th>
                                        <th>الدور</th>
                                        <th>تاريخ التسجيل</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    <tr>
                                        <td colspan="6" class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">جاري التحميل...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Reports Page -->
            <div id="reportsPage" class="page-content" style="display: none;">
                <div class="row mb-4">
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">تقرير المبيعات</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">من تاريخ</label>
                                        <input type="date" class="form-control" id="salesStartDate">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">إلى تاريخ</label>
                                        <input type="date" class="form-control" id="salesEndDate">
                                    </div>
                                </div>
                                <button class="btn btn-primary" id="generateSalesReportBtn">إنشاء التقرير</button>
                                
                                <div id="salesReportContent" class="mt-4" style="display: none;">
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h6>إجمالي الطلبات</h6>
                                                    <h4 id="reportTotalOrders">0</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h6>إجمالي الإيرادات</h6>
                                                    <h4 id="reportTotalRevenue">0</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h6>العملاء</h6>
                                                    <h4 id="reportTotalCustomers">0</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h6>المنتجات المباعة</h6>
                                                    <h4 id="reportTotalProducts">0</h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>المبيعات حسب القسم</h6>
                                            <canvas id="categorySalesChart" height="200"></canvas>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>المبيعات اليومية</h6>
                                            <canvas id="dailySalesChart" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">تقرير المخزون</h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-primary mb-3" id="generateInventoryReportBtn">إنشاء التقرير</button>
                                
                                <div id="inventoryReportContent" class="mt-3" style="display: none;">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h6>إجمالي المنتجات</h6>
                                                    <h4 id="inventoryTotalProducts">0</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h6>المنتجات النافدة</h6>
                                                    <h4 id="inventoryOutOfStock">0</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h6>المنتجات منخفضة المخزون</h6>
                                                    <h4 id="inventoryLowStock">0</h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <h6>المنتجات منخفضة المخزون</h6>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>المنتج</th>
                                                    <th>المخزون الحالي</th>
                                                    <th>الحد الأدنى</th>
                                                </tr>
                                            </thead>
                                            <tbody id="lowStockTable">
                                                <tr>
                                                    <td colspan="3" class="text-center py-3">لا توجد منتجات منخفضة المخزون</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">تقرير العملاء</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-3" id="generateCustomerReportBtn">إنشاء التقرير</button>
                        
                        <div id="customerReportContent" class="mt-3" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6>إجمالي العملاء</h6>
                                            <h4 id="customerTotalCustomers">0</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6>عملاء جدد هذا الشهر</h6>
                                            <h4 id="customerNewCustomers">0</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6>العملاء النشطون</h6>
                                            <h4 id="customerActiveCustomers">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h6>أفضل العملاء</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>العميل</th>
                                            <th>عدد الطلبات</th>
                                            <th>إجمالي الإنفاق</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topCustomersTable">
                                        <tr>
                                            <td colspan="3" class="text-center py-3">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">جاري التحميل...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">إضافة منتج جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">اسم المنتج</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">القسم</label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="">اختر القسم</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">الوصف</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">السعر</label>
                                <input type="number" class="form-control" id="productPrice" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">الكمية</label>
                                <input type="number" class="form-control" id="productStock" min="0" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">الحالة</label>
                                <select class="form-select" id="productStatus" required>
                                    <option value="Active">نشط</option>
                                    <option value="Inactive">غير نشط</option>
                                </select>
                            </div>
                        </div>
                        
                       <div class="mb-3">
    <label class="form-label">صور المنتج</label>
    <div id="productImagesContainer">
        <!-- Existing images will be loaded here -->
    </div>
    <div class="image-upload-area mt-3">
        <label class="form-label">إضافة صور جديدة</label>
        <input type="file" class="form-control" id="productImages" multiple accept="image/*">
        <small class="text-muted d-block mt-2">يمكنك تحميل عدة صور في نفس الوقت. الحد الأقصى لحجم الصورة هو 5 ميجابايت.</small>
    </div>
</div>
                        <div class="mb-3">
                            <label class="form-label">خصم المنتج</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="number" class="form-control" id="productDiscountPercentage" placeholder="نسبة الخصم (%)" min="0" max="100" step="0.1">
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="date" class="form-control" id="productDiscountEndDate" placeholder="تاريخ انتهاء الخصم">
                                        <button class="btn btn-outline-secondary" type="button" id="clearProductDiscountBtn">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">حفظ</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Category Modal -->
    <div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">إضافة قسم جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId">
                        
                        <div class="mb-3">
                            <label class="form-label">اسم القسم</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">الوصف</label>
                            <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">القسم الأصل</label>
                            <select class="form-select" id="parentCategory">
                                <option value="">-- لا يوجد قسم أصل --</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">صورة القسم</label>
                            <div id="categoryImageContainer">
                                <!-- Current image will be loaded here -->
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="removeCategoryImage">
                                <label class="form-check-label" for="removeCategoryImage">
                                    حذف الصورة الحالية
                                </label>
                            </div>
                            <div>
                                <label class="form-label">صورة جديدة (اختياري)</label>
                                <input type="file" class="form-control" id="categoryImage" accept="image/*">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">خصم القسم</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="number" class="form-control" id="categoryDiscountPercentage" placeholder="نسبة الخصم (%)" min="0" max="100" step="0.1">
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="date" class="form-control" id="categoryDiscountEndDate" placeholder="تاريخ انتهاء الخصم">
                                        <button class="btn btn-outline-secondary" type="button" id="clearCategoryDiscountBtn">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveCategoryBtn">حفظ</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Discount Modal -->
    <div class="modal fade" id="discountModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="discountModalTitle">إضافة خصم جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="discountForm">
                        <input type="hidden" id="discountId">
                        
                        <div class="mb-3">
                            <label class="form-label">اسم الخصم</label>
                            <input type="text" class="form-control" id="discountName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">الوصف</label>
                            <textarea class="form-control" id="discountDescription" rows="2"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">نوع الخصم</label>
                            <select class="form-select" id="discountType" required>
                                <option value="">اختر النوع</option>
                                <option value="product">خصم على منتج</option>
                                <option value="category">خصم على قسم</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="discountProductField" style="display: none;">
                            <label class="form-label">المنتج</label>
                            <select class="form-select" id="discountProduct">
                                <option value="">اختر المنتج</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="discountCategoryField" style="display: none;">
                            <label class="form-label">القسم</label>
                            <select class="form-select" id="discountCategory">
                                <option value="">اختر القسم</option>
                            </select>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">نسبة الخصم (%)</label>
                                <input type="number" class="form-control" id="discountPercentage" min="1" max="100" step="0.1" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">الحالة</label>
                                <select class="form-select" id="discountActive">
                                    <option value="true" selected>نشط</option>
                                    <option value="false">غير نشط</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">تاريخ البدء</label>
                                <input type="date" class="form-control" id="discountStartDate" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">تاريخ الانتهاء</label>
                                <input type="date" class="form-control" id="discountEndDate" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveDiscountBtn">حفظ</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تفاصيل الطلب</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="orderDetailsContent">
                        <!-- Order details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Coupon Modal -->
    <div class="modal fade" id="couponModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="couponModalTitle">إضافة كوبون جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="couponForm">
                        <input type="hidden" id="couponId">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">كود الكوبون</label>
                                <input type="text" class="form-control" id="couponCode" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">نسبة الخصم (%)</label>
                                <input type="number" class="form-control" id="couponDiscount" min="1" max="100" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">تاريخ الانتهاء</label>
                                <input type="date" class="form-control" id="couponExpiry" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">الحد الأقصى للاستخدام</label>
                                <input type="number" class="form-control" id="couponUsageLimit" min="0">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">الحد الأدنى لقيمة الطلب</label>
                            <input type="number" class="form-control" id="couponMinAmount" step="0.01" min="0">
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="couponActive" checked>
                            <label class="form-check-label" for="couponActive">
                                نشط
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveCouponBtn">حفظ</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- API Base URL Configuration -->
    <script>
        window.API_BASE_URL = 'https://localhost:7124/api';
    </script>
    
    <!-- Admin Dashboard JavaScript -->
 <script>
    // أضف هذه الدالة في بداية الـ script
function validateToken() {
    const token = localStorage.getItem('token');
    if (!token) {
        // إذا لم يوجد توكن، توجيه إلى صفحة Login
        window.location.href = 'login.html';
        return false;
    }
    
    // التحقق من انتهاء صلاحية التوكن (اختياري)
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const expiry = payload.exp * 1000; // تحويل إلى ميلي ثانية
        if (Date.now() >= expiry) {
            // إذا انتهت صلاحية التوكن
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
            return false;
        }
    } catch (e) {
        // إذا كان التوكن غير صالح
        localStorage.removeItem('token');
        localStorage.removeItem('userRole');
        window.location.href = 'login.html';
        return false;
    }
    
    return true;
}
    document.addEventListener('DOMContentLoaded', () => {
    // Global variables
    let currentPage = 'dashboard';
    let salesChart, categorySalesChart, dailySalesChart;
    
    // Initialize
    checkAuthentication();
    initializeEventListeners();
    loadDashboardData();
    
    // Check if user is authenticated
    function checkAuthentication() {
        const token = localStorage.getItem('token');
        const userRole = localStorage.getItem('userRole');
        
        if (!token || userRole !== 'Admin') {
            window.location.href = 'login.html';
        }
    }
    
    // Initialize event listeners
    function initializeEventListeners() {
        // Sidebar navigation
        document.querySelectorAll('.sidebar-item[data-page]').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const page = this.getAttribute('data-page');
                navigateToPage(page);
            });
        });
        
        document.addEventListener('ajaxError', function(e) {
    if (e.detail.status === 401) {
        showNotification('انتهت جلسة العمل، يرجى تسجيل الدخول مرة أخرى', 'warning');
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 2000);
    }
});
        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            logout();
        });
        
        // Menu toggle for mobile
        document.getElementById('menuToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('active');
        });
        
        // Product management
        document.getElementById('addProductBtn').addEventListener('click', function() {
            openProductModal();
        });
        
        document.getElementById('saveProductBtn').addEventListener('click', function() {
            saveProduct();
        });
        
        document.getElementById('searchProductBtn').addEventListener('click', function() {
            loadProducts();
        });
        
        document.getElementById('categoryFilter').addEventListener('change', function() {
            loadProducts();
        });
        
        document.getElementById('statusFilter').addEventListener('change', function() {
            loadProducts();
        });
        
        // Clear product discount button
        document.getElementById('clearProductDiscountBtn').addEventListener('click', function() {
            document.getElementById('productDiscountPercentage').value = '';
            document.getElementById('productDiscountEndDate').value = '';
        });
        
        // Category management
        document.getElementById('addCategoryBtn').addEventListener('click', function() {
            openCategoryModal();
        });
        
        document.getElementById('saveCategoryBtn').addEventListener('click', function() {
            saveCategory();
        });
        
        // Clear category discount button
        document.getElementById('clearCategoryDiscountBtn').addEventListener('click', function() {
            document.getElementById('categoryDiscountPercentage').value = '';
            document.getElementById('categoryDiscountEndDate').value = '';
        });
        
        // Discount management
        document.getElementById('addDiscountBtn').addEventListener('click', function() {
            openDiscountModal();
        });
        
        document.getElementById('saveDiscountBtn').addEventListener('click', function() {
            saveDiscount();
        });
        
        document.getElementById('searchDiscountBtn').addEventListener('click', function() {
            loadDiscounts();
        });
        
        document.getElementById('discountTypeFilter').addEventListener('change', function() {
            loadDiscounts();
        });
        
        document.getElementById('discountStatusFilter').addEventListener('change', function() {
            loadDiscounts();
        });
        
        // Discount type change handler
        document.getElementById('discountType').addEventListener('change', function() {
            const type = this.value;
            const productField = document.getElementById('discountProductField');
            const categoryField = document.getElementById('discountCategoryField');
            
            if (type === 'product') {
                productField.style.display = 'block';
                categoryField.style.display = 'none';
                loadProductsForDiscount();
            } else if (type === 'category') {
                productField.style.display = 'none';
                categoryField.style.display = 'block';
                loadCategoriesForDiscount();
            } else {
                productField.style.display = 'none';
                categoryField.style.display = 'none';
            }
        });
        
        // Order management
        document.getElementById('searchOrderBtn').addEventListener('click', function() {
            loadOrders();
        });
        
        document.getElementById('orderStatusFilter').addEventListener('change', function() {
            loadOrders();
        });
        
        document.getElementById('orderDateFilter').addEventListener('change', function() {
            loadOrders();
        });
        
        // Coupon management
        document.getElementById('addCouponBtn').addEventListener('click', function() {
            openCouponModal();
        });
        
        document.getElementById('saveCouponBtn').addEventListener('click', function() {
            saveCoupon();
        });
        
        // User management
        document.getElementById('searchUserBtn').addEventListener('click', function() {
            loadUsers();
        });
        
        document.getElementById('userRoleFilter').addEventListener('change', function() {
            loadUsers();
        });
        
        document.getElementById('userDateFilter').addEventListener('change', function() {
            loadUsers();
        });
        
        // Reports
        document.getElementById('generateSalesReportBtn').addEventListener('click', function() {
            generateSalesReport();
        });
        
        document.getElementById('generateInventoryReportBtn').addEventListener('click', function() {
            generateInventoryReport();
        });
        
        document.getElementById('generateCustomerReportBtn').addEventListener('click', function() {
            generateCustomerReport();
        });
    }
    
    // Navigate to a page
    function navigateToPage(page) {
        // Update active sidebar item
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`.sidebar-item[data-page="${page}"]`).classList.add('active');
        
        // Update page title
        const titles = {
            'dashboard': 'لوحة التحكم',
            'products': 'المنتجات',
            'categories': 'الأقسام',
            'discounts': 'الخصومات',
            'orders': 'الطلبات',
            'coupons': 'الكوبونات',
            'users': 'المستخدمون',
            'reports': 'التقارير'
        };
        document.getElementById('pageTitle').textContent = titles[page];
        
        // Hide all pages
        document.querySelectorAll('.page-content').forEach(content => {
            content.style.display = 'none';
        });
        
        // Show current page
        document.getElementById(`${page}Page`).style.display = 'block';
        
        // Load page data
        currentPage = page;
        switch (page) {
            case 'dashboard':
                loadDashboardData();
                break;
            case 'products':
                loadProducts();
                loadCategoriesForFilter();
                break;
            case 'categories':
                loadCategories();
                break;
            case 'discounts':
                loadDiscounts();
                break;
            case 'orders':
                loadOrders();
                break;
            case 'coupons':
                loadCoupons();
                break;
            case 'users':
                loadUsers();
                break;
            case 'reports':
                initializeReports();
                break;
        }
    }
    
    // API request helper
// API request helper
async function apiRequest(url, options = {}) {
    // التحقق من صحة التوكن أولاً
    if (!validateToken()) {
        throw new Error('Token is invalid or expired');
    }
    
    const token = localStorage.getItem('token');
    
    const defaultOptions = {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    };
    
    // Don't set Content-Type for FormData, let the browser set it automatically
    if (options.body && !(options.body instanceof FormData)) {
        defaultOptions.headers['Content-Type'] = 'application/json';
        
        // If body is an object, convert it to JSON
        if (typeof options.body === 'object' && !(options.body instanceof FormData)) {
            options.body = JSON.stringify(options.body);
        }
    }
    
    const config = { ...defaultOptions, ...options };
    
    try {
        const response = await fetch(`${window.API_BASE_URL}${url}`, config);
        
        if (response.status === 401) {
            // If the error is 401, logout
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
            throw new Error('Session expired. Please login again.');
        }
        
        if (!response.ok) {
            let errorMessage = 'Request failed';
            
            try {
                const error = await response.json();
                errorMessage = error.message || JSON.stringify(error);
                
                if (error.errors) {
                    const validationErrors = Object.values(error.errors).flat();
                    errorMessage = validationErrors.join(', ');
                }
            } catch (e) {
                errorMessage = response.statusText || `Unknown error (${response.status})`;
            }
            
            throw new Error(errorMessage);
        }
        
        // If the response is empty (like in case of DELETE)
        if (response.status === 204) {
            return null;
        }
        
        return await response.json();
    } catch (error) {
        console.error('API Request Error:', error);
        throw error;
    }
}


    // Show notification
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const icons = {
            'success': 'bi-check-circle',
            'warning': 'bi-exclamation-triangle',
            'danger': 'bi-x-circle'
        };
        
        notification.innerHTML = `
            <i class="bi ${icons[type]}"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        // Show notification
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);
        
        // Hide notification after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
    
    // Logout
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('userRole');
        localStorage.removeItem('userName');
        window.location.href = 'login.html';
    }
    
    // Image handling functions
    function arrayBufferToBase64(buffer) {
        // If buffer is already a string, assume it's already base64 encoded
        if (typeof buffer === 'string') {
            return buffer;
        }
        
        // If buffer is null or undefined, return empty string
        if (!buffer) {
            return '';
        }
        
        // Handle ArrayBuffer
        if (buffer instanceof ArrayBuffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            
            return window.btoa(binary);
        }
        
        // Handle Uint8Array
        if (buffer instanceof Uint8Array) {
            let binary = '';
            const len = buffer.byteLength;
            
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(buffer[i]);
            }
            
            return window.btoa(binary);
        }
        
        // If it's a base64 string in a different format
        if (typeof buffer === 'object' && buffer.data) {
            return arrayBufferToBase64(buffer.data);
        }
        
        // Last resort - try to convert to string
        try {
            return window.btoa(String(buffer));
        } catch (e) {
            console.error('Unsupported buffer type:', typeof buffer, buffer);
            return '';
        }
    }
    
    // Get image URL with fallback
    function getImageUrl(imageData, mimeType, placeholderSize = '50x50') {
        if (!imageData) {
            return `https://via.placeholder.com/${placeholderSize}?text=No+Image`;
        }
        
        try {
            // Try to handle different image data formats
            let base64;
            
            if (typeof imageData === 'string') {
                // If it's already a base64 string
                base64 = imageData;
            } else {
                // Convert buffer to base64
                base64 = arrayBufferToBase64(imageData);
            }
            
            // If we got a valid base64 string, create data URL
            if (base64) {
                return `data:${mimeType || 'image/jpeg'};base64,${base64}`;
            }
            
            // Fallback to placeholder
            return `https://via.placeholder.com/${placeholderSize}?text=No+Image`;
        } catch (error) {
            console.error('Error processing image data:', error);
            return `https://via.placeholder.com/${placeholderSize}?text=Error`;
        }
    }
    
    // Load dashboard data
    async function loadDashboardData() {
        try {
            // Load stats
            const products = await apiRequest('/products?status=Active');
            const orders = await apiRequest('/orders/all?status=Pending');
            const users = await apiRequest('/users');
            
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('newOrders').textContent = orders.length;
            document.getElementById('newUsers').textContent = users.filter(u => {
                const userDate = new Date(u.createdAt);
                const now = new Date();
                const diffTime = Math.abs(now - userDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 30;
            }).length;
            
            // Calculate total sales (this would normally come from a report endpoint)
            let totalSales = 0;
            const allOrders = await apiRequest('/orders/all');
            allOrders.forEach(order => {
                if (order.status !== 'Cancelled') {
                    totalSales += order.finalAmount || order.orderTotal;
                }
            });
            document.getElementById('totalSales').textContent = formatPrice(totalSales);
            
            // Load sales chart
            loadSalesChart();
            
            // Load top products
            loadTopProducts();
            
            // Load recent orders
            loadRecentOrders();
            
            // Load active users
            loadActiveUsers();
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showNotification('فشل تحميل بيانات لوحة التحكم', 'danger');
        }
    }
    
    // Load sales chart
    async function loadSalesChart() {
        try {
            // Get current month data
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            // FIXED: Use ISO date format
            const report = await apiRequest(`/admin/sales-report?startDate=${startOfMonth.toISOString().split('T')[0]}&endDate=${endOfMonth.toISOString().split('T')[0]}`);
            
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (salesChart) {
                salesChart.destroy();
            }
            
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: report.dailySales.map(d => formatDateForChart(d.date)),
                    datasets: [{
                        label: 'إجمالي المبيعات',
                        data: report.dailySales.map(d => d.revenue),
                        backgroundColor: 'rgba(26, 54, 93, 0.1)',
                        borderColor: 'rgba(26, 54, 93, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatPrice(value);
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading sales chart:', error);
        }
    }
    
    // Load top products
    async function loadTopProducts() {
        try {
            const products = await apiRequest('/products?status=Active');
            
            // Sort by sales (this would normally come from the backend)
            // For now, we'll just show the first 5 products
            const topProducts = products.slice(0, 5);
            
            const container = document.getElementById('topProducts');
            container.innerHTML = '';
            
            if (topProducts.length === 0) {
                container.innerHTML = '<p class="text-center">لا توجد منتجات</p>';
                return;
            }
            
            topProducts.forEach(product => {
                const item = document.createElement('div');
                item.className = 'd-flex align-items-center mb-3';
                
                const primaryImage = product.images && product.images.length > 0 
                    ? product.images.find(img => img.isPrimary) || product.images[0]
                    : null;
                
                const imageUrl = getImageUrl(
                    primaryImage ? primaryImage.imageData : null, 
                    primaryImage ? primaryImage.mimeType : null
                );
                
                item.innerHTML = `
                    <img src="${imageUrl}" alt="${product.name}" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
                    <div>
                        <h6 class="mb-0">${product.name}</h6>
                        <small class="text-muted">${formatPrice(product.price)}</small>
                    </div>
                `;
                
                container.appendChild(item);
            });
        } catch (error) {
            console.error('Error loading top products:', error);
            document.getElementById('topProducts').innerHTML = '<p class="text-center text-danger">فشل تحميل المنتجات</p>';
        }
    }
    
    // Load recent orders
    async function loadRecentOrders() {
        try {
            const orders = await apiRequest('/orders/all');
            
            // Sort by date and take the first 5
            const recentOrders = orders
                .sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate))
                .slice(0, 5);
            
            const tbody = document.getElementById('recentOrders');
            tbody.innerHTML = '';
            
            if (recentOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">لا توجد طلبات</td></tr>';
                return;
            }
            
            recentOrders.forEach(order => {
                const tr = document.createElement('tr');
                
                const statusClass = order.status.toLowerCase();
                
                tr.innerHTML = `
                    <td>${order.orderNumber}</td>
                    <td>${order.userName}</td>
                    <td>${formatDate(order.orderDate)}</td>
                    <td><span class="status-badge ${statusClass}">${getStatusText(order.status)}</span></td>
                    <td>${formatPrice(order.finalAmount || order.orderTotal)}</td>
                `;
                
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading recent orders:', error);
            document.getElementById('recentOrders').innerHTML = '<tr><td colspan="5" class="text-center text-danger">فشل تحميل الطلبات</td></tr>';
        }
    }
    
    // Load active users
    async function loadActiveUsers() {
        try {
            const report = await apiRequest('/admin/customer-report');
            
            const tbody = document.getElementById('activeUsers');
            tbody.innerHTML = '';
            
            if (report.topCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">لا توجد بيانات</td></tr>';
                return;
            }
            
            report.topCustomers.slice(0, 5).forEach(user => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${user.customerName}</td>
                    <td>${user.customerId}</td>
                    <td>${user.ordersCount}</td>
                    <td>${formatPrice(user.totalSpent)}</td>
                `;
                
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading active users:', error);
            document.getElementById('activeUsers').innerHTML = '<tr><td colspan="4" class="text-center text-danger">فشل تحميل المستخدمين</td></tr>';
        }
    }
    
    // Load products
    async function loadProducts() {
    try {
        const search = document.getElementById('productSearch').value;
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        let url = '/products?';
        if (search) url += `search=${search}&`;
        if (category) url += `categoryId=${category}&`;
        if (status) url += `status=${status}&`;
        
        console.log('Fetching products from:', url);
        const products = await apiRequest(url);
        console.log('Received products:', products);
        
        const tbody = document.getElementById('productsTable');
        tbody.innerHTML = '';
        
        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">لا توجد منتجات</td></tr>';
            return;
        }
        
        products.forEach(product => {
            console.log(`Product: ${product.name}, Price: ${product.price}, Discounted: ${product.discountedPrice}`);
            
            const tr = document.createElement('tr');
            
            const primaryImage = product.images && product.images.length > 0 
                ? product.images.find(img => img.isPrimary) || product.images[0]
                : null;
            
            const imageUrl = getImageUrl(
                primaryImage ? primaryImage.imageData : null, 
                primaryImage ? primaryImage.mimeType : null
            );
            
            const statusClass = product.status.toLowerCase();
            
            // Fixed discount display logic
            let priceDisplay = '';
            let discountBadge = '';
            
            if (product.discountedPrice && product.discountedPrice < product.price) {
                const savings = product.price - product.discountedPrice;
                const savingsPercent = Math.round((savings / product.price) * 100);
                
                priceDisplay = `
                    <div>
                        <span class="text-decoration-line-through text-muted">${formatPrice(product.price)}</span>
                        <span class="text-danger fw-bold">${formatPrice(product.discountedPrice)}</span>
                    </div>
                `;
                
                discountBadge = `<span class="badge bg-success me-2">خصم ${savingsPercent}%</span>`;
            } else {
                priceDisplay = `<div>${formatPrice(product.price)}</div>`;
            }
            
            tr.innerHTML = `
                <td>
                    <img src="${imageUrl}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
                </td>
                <td>${discountBadge}${product.name}</td>
                <td>${product.categoryName}</td>
                <td>${formatPrice(product.price)}</td>
                <td>${priceDisplay}</td>
                <td>${product.stockQuantity}</td>
                <td><span class="status-badge ${statusClass}">${product.status === 'Active' ? 'نشط' : 'غير نشط'}</span></td>
                <td>
                    <button class="btn btn-sm btn-primary me-1 edit-product-btn" data-id="${product.id}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-product-btn" data-id="${product.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(tr);
        });
        
        // Add event listeners to edit and delete buttons
        document.querySelectorAll('.edit-product-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.getAttribute('data-id');
                openProductModal(productId);
            });
        });
        
        document.querySelectorAll('.delete-product-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.getAttribute('data-id');
                deleteProduct(productId);
            });
        });
    } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('productsTable').innerHTML = '<tr><td colspan="8" class="text-center text-danger">فشل تحميل المنتجات</td></tr>';
    }
}
    
    // Load categories for filter
    async function loadCategoriesForFilter() {
        try {
            const categories = await apiRequest('/categories');
            
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">جميع الأقسام</option>';
            
            function addCategoryOptions(categories) {
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    select.appendChild(option);
                    
                    // Add subcategories
                    if (category.subCategories && category.subCategories.length > 0) {
                        addCategoryOptions(category.subCategories);
                    }
                });
            }
            
            addCategoryOptions(categories);
        } catch (error) {
            console.error('Error loading categories for filter:', error);
        }
    }
    
    // Open product modal
    
// Open product modal
// Open product modal
async function openProductModal(productId = null) {
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    const modalTitle = document.getElementById('productModalTitle');
    const form = document.getElementById('productForm');
    
    // Reset form
    form.reset();
    
    // Load categories
    try {
        const categories = await apiRequest('/categories');
        
        const select = document.getElementById('productCategory');
        select.innerHTML = '<option value="">اختر القسم</option>';
        
        function addCategoryOptions(categories, level = 0) {
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = '  '.repeat(level) + category.name;
                select.appendChild(option);
                
                if (category.subCategories && category.subCategories.length > 0) {
                    addCategoryOptions(category.subCategories, level + 1);
                }
            });
        }
        
        addCategoryOptions(categories);
    } catch (error) {
        console.error('Error loading categories:', error);
    }
    
    if (productId) {
        // Edit existing product
        modalTitle.textContent = 'تعديل المنتج';
        
        try {
            const product = await apiRequest(`/products/${productId}`);
            
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productCategory').value = product.categoryId;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productStock').value = product.stockQuantity;
            document.getElementById('productStatus').value = product.status;
            
            // Load existing images with improved design
            const imagesContainer = document.getElementById('productImagesContainer');
            imagesContainer.innerHTML = '';
            
            if (product.images && product.images.length > 0) {
                imagesContainer.innerHTML = '<div class="product-images-container"></div>';
                const container = imagesContainer.querySelector('.product-images-container');
                
                product.images.forEach(image => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'product-image-item';
                    
                    const imageUrl = getImageUrl(image.imageData, image.mimeType);
                    
                    imageItem.innerHTML = `
                        <img src="${imageUrl}" alt="Product Image">
                        ${image.isPrimary ? '<div class="image-badge">الرئيسية</div>' : ''}
                        <button class="image-remove" data-id="${image.id}">
                            <i class="bi bi-x"></i>
                        </button>
                        <div class="image-actions">
                            <div class="image-checkbox">
                                <input type="checkbox" id="primary-${image.id}" ${image.isPrimary ? 'checked' : ''}>
                                <label for="primary-${image.id}">الصورة الرئيسية</label>
                            </div>
                            <div class="image-checkbox">
                                <input type="checkbox" id="remove-${image.id}">
                                <label for="remove-${image.id}">حذف الصورة</label>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(imageItem);
                });
                
                // Add event listeners to remove buttons
                document.querySelectorAll('.image-remove').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const imageId = this.getAttribute('data-id');
                        document.getElementById(`remove-${imageId}`).checked = true;
                        this.closest('.product-image-item').style.opacity = '0.5';
                        this.style.display = 'none';
                    });
                });
                
                // Add event listeners to primary checkboxes
                document.querySelectorAll('.product-image-item input[id^="primary-"]').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            // Uncheck all other primary checkboxes
                            document.querySelectorAll('.product-image-item input[id^="primary-"]').forEach(cb => {
                                if (cb !== this) cb.checked = false;
                            });
                            
                            // Update badges
                            document.querySelectorAll('.image-badge').forEach(badge => {
                                badge.remove();
                            });
                            
                            // Add badge to selected image
                            const badge = document.createElement('div');
                            badge.className = 'image-badge';
                            badge.textContent = 'الرئيسية';
                            this.closest('.product-image-item').appendChild(badge);
                        }
                    });
                });
            } else {
                imagesContainer.innerHTML = '<div class="no-images-message">لا توجد صور حالياً</div>';
            }
            
            // Load product discount if exists
            if (product.discount) {
                document.getElementById('productDiscountPercentage').value = product.discount.discountPercentage;
                document.getElementById('productDiscountEndDate').value = formatDateForInput(product.discount.endDate);
            }
        } catch (error) {
            console.error('Error loading product:', error);
            showNotification('فشل تحميل بيانات المنتج', 'danger');
            return;
        }
    } else {
        // Add new product
        modalTitle.textContent = 'إضافة منتج جديد';
        document.getElementById('productId').value = '';
        document.getElementById('productImagesContainer').innerHTML = '<div class="no-images-message">لا توجد صور حالياً</div>';
    }
    
    modal.show();
}


// Add this function to test discount calculation
async function testDiscountCalculation() {
    try {
        // Test a specific product ID
        const productId = 1; // Change to a product ID that should have discounts
        const product = await apiRequest(`/products/${productId}`);
        
        console.log('=== DISCOUNT DEBUG INFO ===');
        console.log('Product:', product);
        console.log('Original Price:', product.price);
        console.log('Discounted Price:', product.discountedPrice);
        console.log('Discount Object:', product.discount);
        
        if (product.discount) {
            console.log('Discount Percentage:', product.discount.discountPercentage);
            console.log('Discount Start:', product.discount.startDate);
            console.log('Discount End:', product.discount.endDate);
            console.log('Discount Active:', product.discount.isActive);
            
            const now = new Date();
            const startDate = new Date(product.discount.startDate);
            const endDate = new Date(product.discount.endDate);
            
            console.log('Current Date:', now);
            console.log('Is Discount Active?', now >= startDate && now <= endDate);
        }
        
        // Test category discounts
        if (product.categoryId) {
            const category = await apiRequest(`/categories/${product.categoryId}`);
            console.log('Category:', category);
            console.log('Category Discount:', category.discount);
            
            if (category.discount) {
                console.log('Category Discount Percentage:', category.discount.discountPercentage);
                console.log('Category Discount Start:', category.discount.startDate);
                console.log('Category Discount End:', category.discount.endDate);
                
                const now = new Date();
                const startDate = new Date(category.discount.startDate);
                const endDate = new Date(category.discount.endDate);
                
                console.log('Is Category Discount Active?', now >= startDate && now <= endDate);
            }
        }
    } catch (error) {
        console.error('Discount test failed:', error);
    }
}

// Call this function from the browser console when debugging
window.testDiscountCalculation = testDiscountCalculation;

// Helper function to check if category is a descendant of another category
function isDescendant(category, parentId) {
    if (category.parentCategoryId == parentId) {
        return true;
    }
    
    if (category.subCategories) {
        for (const subCategory of category.subCategories) {
            if (isDescendant(subCategory, parentId)) {
                return true;
            }
        }
    }
    
    return false;
}
    
    // Save product
// Save product
async function saveProduct() {
    const productId = document.getElementById('productId').value;
    const isEdit = !!productId;
    
    const name = document.getElementById('productName').value;
    const description = document.getElementById('productDescription').value;
    const categoryId = document.getElementById('productCategory').value;
    const price = parseFloat(document.getElementById('productPrice').value);
    const stockQuantity = parseInt(document.getElementById('productStock').value);
    const status = document.getElementById('productStatus').value;
    
    // Validate form
    if (!name || !categoryId || isNaN(price) || isNaN(stockQuantity)) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'warning');
        return;
    }
    
    const formData = new FormData();
    
    // Always include all required fields
    formData.append('Name', name);
    formData.append('Description', description || '');
    formData.append('CategoryId', categoryId);
    formData.append('Price', price);
    formData.append('StockQuantity', stockQuantity);
    formData.append('Status', status);
    
    // Process existing images only if we're editing
    if (isEdit) {
        const imageUpdates = [];
        document.querySelectorAll('.product-image-item').forEach(item => {
            const imageId = item.querySelector('input[id^="primary-"]').id.split('-')[1];
            const isPrimary = item.querySelector(`#primary-${imageId}`).checked;
            const remove = item.querySelector(`#remove-${imageId}`).checked;
            
            imageUpdates.push({
                id: parseInt(imageId),
                isPrimary: isPrimary,
                remove: remove
            });
        });
        
        // Convert image updates to JSON string
        formData.append('ImageUpdates', JSON.stringify(imageUpdates));
        
        // Add new images only if any are selected
        const imageFiles = document.getElementById('productImages').files;
        if (imageFiles && imageFiles.length > 0) {
            for (let i = 0; i < imageFiles.length; i++) {
                if (imageFiles[i].size > 0) {
                    formData.append('NewImageFiles', imageFiles[i]);
                }
            }
        }
    } else {
        // For new products, handle images differently
        const imageFiles = document.getElementById('productImages').files;
        if (imageFiles && imageFiles.length > 0) {
            for (let i = 0; i < imageFiles.length; i++) {
                if (imageFiles[i].size > 0) {
                    formData.append('ImageFiles', imageFiles[i]);
                }
            }
        }
    }
    
    try {
        let response;
        if (isEdit) {
            response = await apiRequest(`/products/${productId}`, {
                method: 'PUT',
                body: formData
            });
            
            // Save product discount if provided
            const discountPercentage = document.getElementById('productDiscountPercentage').value;
            const discountEndDate = document.getElementById('productDiscountEndDate').value;
            
            if (discountPercentage && discountEndDate) {
                // Check if product already has a discount
                const existingDiscounts = await apiRequest('/Discount?active=true');
                const productDiscount = existingDiscounts.find(d => d.productId == parseInt(productId));
                
                if (productDiscount) {
                    // Update existing discount
                    await apiRequest(`/Discount/${productDiscount.id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            name: `خصم على ${name}`,
                            description: `خصم ${discountPercentage}% على ${name}`,
                            discountPercentage: parseFloat(discountPercentage),
                            startDate: new Date().toISOString().split('T')[0],
                            endDate: discountEndDate,
                            isActive: true
                        })
                    });
                } else {
                    // Create new discount
                    await apiRequest('/Discount', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: `خصم على ${name}`,
                            description: `خصم ${discountPercentage}% على ${name}`,
                            discountPercentage: parseFloat(discountPercentage),
                            startDate: new Date().toISOString().split('T')[0],
                            endDate: discountEndDate,
                            productId: parseInt(productId),
                            isActive: true
                        })
                    });
                }
            }
        } else {
            response = await apiRequest('/products', {
                method: 'POST',
                body: formData
            });
        }
        
        // Close modal and fix focus issue
        closeModal('productModal');
        
        // Show notification
        showNotification(isEdit ? 'تم تحديث المنتج بنجاح' : 'تمت إضافة المنتج بنجاح');
        
        // Reload products
        loadProducts();
    } catch (error) {
        console.error('Error saving product:', error);
        showNotification(error.message || 'فشل حفظ المنتج', 'danger');
    }
}

    // Delete product
    async function deleteProduct(productId) {
        if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
            return;
        }
        
        try {
            await apiRequest(`/products/${productId}`, {
                method: 'DELETE'
            });
            
            showNotification('تم حذف المنتج بنجاح');
            loadProducts();
        } catch (error) {
            console.error('Error deleting product:', error);
            showNotification(error.message || 'فشل حذف المنتج', 'danger');
        }
    }
    
    // Add this to your dashboard.html script
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    const modalInstance = bootstrap.Modal.getInstance(modal);
    
    // Remove focus from any focused element within the modal
    const activeElement = document.activeElement;
    if (activeElement && modal.contains(activeElement)) {
        activeElement.blur();
    }
    
    // Hide the modal
    modalInstance.hide();
    
    // Wait for the modal to be hidden before removing aria-hidden
    modal.addEventListener('hidden.bs.modal', function() {
        modal.removeAttribute('aria-hidden');
    }, { once: true });
}

    // Load categories
    async function loadCategories() {
    try {
        console.log('Loading categories...');
        const categories = await apiRequest('/categories');
        console.log('Received categories:', categories);
        
        const tbody = document.getElementById('categoriesTable');
        tbody.innerHTML = '';
        
        if (categories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد أقسام</td></tr>';
            return;
        }
        
        function addCategoryRows(categories, level = 0) {
            categories.forEach(category => {
                console.log(`Category: ${category.name}, Discount:`, category.discount);
                
                const tr = document.createElement('tr');
                
                const imageUrl = getImageUrl(category.categoryImage, category.imageMimeType, '50x50');
                
                // Fixed discount display logic
                let discountHtml = '-';
                if (category.discount) {
                    const now = new Date();
                    const startDate = new Date(category.discount.startDate);
                    const endDate = new Date(category.discount.endDate);
                    
                    if (category.discount.isActive && now >= startDate && now <= endDate) {
                        discountHtml = `<span class="badge bg-success">${category.discount.discountPercentage}%</span>`;
                    }
                }
                
                tr.innerHTML = `
                    <td>
                        <img src="${imageUrl}" alt="${category.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
                    </td>
                    <td>${'  '.repeat(level)}${category.name}</td>
                    <td>${category.description || 'لا يوجد وصف'}</td>
                    <td>${category.parentCategoryName || '-'}</td>
                    <td>${discountHtml}</td>
                    <td>${category.subCategories ? category.subCategories.length : 0}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1 edit-category-btn" data-id="${category.id}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-category-btn" data-id="${category.id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
                
                // Add subcategories
                if (category.subCategories && category.subCategories.length > 0) {
                    addCategoryRows(category.subCategories, level + 1);
                }
            });
        }
        
        addCategoryRows(categories);
        
        // Add event listeners to edit and delete buttons
        document.querySelectorAll('.edit-category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-id');
                openCategoryModal(categoryId);
            });
        });
        
        document.querySelectorAll('.delete-category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-id');
                deleteCategory(categoryId);
            });
        });
    } catch (error) {
        console.error('Error loading categories:', error);
        document.getElementById('categoriesTable').innerHTML = '<tr><td colspan="7" class="text-center text-danger">فشل تحميل الأقسام</td></tr>';
    }
}

    
    // Open category modal
    async function openCategoryModal(categoryId = null) {
    const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
    const modalTitle = document.getElementById('categoryModalTitle');
    const form = document.getElementById('categoryForm');
    
    // Reset form
    form.reset();
    document.getElementById('categoryImageContainer').innerHTML = '';
    
    // Load parent categories
    try {
        const categories = await apiRequest('/categories');
        
        const select = document.getElementById('parentCategory');
        select.innerHTML = '<option value="">-- لا يوجد قسم أصل --</option>';
        
        function addCategoryOptions(categories, level = 0) {
            categories.forEach(category => {
                // Skip current category and its children when editing
                if (categoryId && (category.id == categoryId || isDescendant(category, categoryId))) {
                    return;
                }
                
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = '  '.repeat(level) + category.name;
                select.appendChild(option);
                
                // Add subcategories
                if (category.subCategories && category.subCategories.length > 0) {
                    addCategoryOptions(category.subCategories, level + 1);
                }
            });
        }
        
        addCategoryOptions(categories);
    } catch (error) {
        console.error('Error loading parent categories:', error);
    }
    
    if (categoryId) {
        // Edit existing category
        modalTitle.textContent = 'تعديل القسم';
        
        try {
            console.log('Loading category with ID:', categoryId);
            const category = await apiRequest(`/categories/${categoryId}`);
            console.log('Loaded category:', category);
            
            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryDescription').value = category.description || '';
            document.getElementById('parentCategory').value = category.parentCategoryId || '';
            
            // Load current image
            const imageContainer = document.getElementById('categoryImageContainer');
            
            if (category.categoryImage) {
                const imageUrl = getImageUrl(category.categoryImage, category.imageMimeType, '200x200');
                imageContainer.innerHTML = `
                    <img src="${imageUrl}" alt="Category Image" class="img-thumbnail" style="max-height: 200px;">
                `;
            } else {
                imageContainer.innerHTML = '<p>لا توجد صورة حالياً</p>';
            }
            
            // Load category discount if exists
            console.log('Category discount:', category.discount);
            if (category.discount) {
                document.getElementById('categoryDiscountPercentage').value = category.discount.discountPercentage;
                document.getElementById('categoryDiscountEndDate').value = formatDateForInput(category.discount.endDate);
            } else {
                // Clear discount fields if no discount
                document.getElementById('categoryDiscountPercentage').value = '';
                document.getElementById('categoryDiscountEndDate').value = '';
            }
        } catch (error) {
            console.error('Error loading category:', error);
            showNotification('فشل تحميل بيانات القسم', 'danger');
            return;
        }
    } else {
        // Add new category
        modalTitle.textContent = 'إضافة قسم جديد';
        document.getElementById('categoryId').value = '';
        document.getElementById('categoryImageContainer').innerHTML = '<p>لا توجد صورة حالياً</p>';
        
        // Clear discount fields for new category
        document.getElementById('categoryDiscountPercentage').value = '';
        document.getElementById('categoryDiscountEndDate').value = '';
    }
    
    modal.show();
}

    
    // Check if category is a descendant of another category
    function isDescendant(category, parentId) {
        if (category.parentCategoryId == parentId) {
            return true;
        }
        
        if (category.subCategories) {
            for (const subCategory of category.subCategories) {
                if (isDescendant(subCategory, parentId)) {
                    return true;
                }
            }
        }
        
        return false;
    }
    
    // Save category


    async function saveCategory() {
    // التحقق من صحة التوكن أولاً
    if (!validateToken()) {
        return;
    }
    
    const categoryId = document.getElementById('categoryId').value;
    const isEdit = !!categoryId;
    
    const name = document.getElementById('categoryName').value;
    const description = document.getElementById('categoryDescription').value;
    const parentCategoryId = document.getElementById('parentCategory').value || null;
    const removeImage = document.getElementById('removeCategoryImage').checked;
    const imageFile = document.getElementById('categoryImage').files[0];
    
    // التحقق من صحة النموذج
    if (!name) {
        showNotification('يرجى إدخال اسم القسم', 'warning');
        return;
    }
    
    // استخدام FormData دائماً لأنه أكثر مرونة
    const formData = new FormData();
    formData.append('Name', name);
    formData.append('Description', description || '');
    formData.append('RemoveImage', removeImage.toString());
    
    if (parentCategoryId) {
        formData.append('ParentCategoryId', parentCategoryId);
    }
    
    // فقط أضف ImageFile إذا كان هناك ملف حقيقي
    if (imageFile && imageFile.size > 0) {
        formData.append('ImageFile', imageFile);
    }
    
    try {
        let response;
        if (isEdit) {
            response = await apiRequest(`/categories/${categoryId}`, {
                method: 'PUT',
                body: formData
            });
            
            // Save category discount if provided
            const discountPercentage = document.getElementById('categoryDiscountPercentage').value;
            const discountEndDate = document.getElementById('categoryDiscountEndDate').value;
            
            if (discountPercentage && discountEndDate) {
                // Check if category already has a discount
                const existingDiscounts = await apiRequest('/Discount?active=true');
                const categoryDiscount = existingDiscounts.find(d => d.categoryId == parseInt(categoryId));
                
                if (categoryDiscount) {
                    // Update existing discount
                    await apiRequest(`/Discount/${categoryDiscount.id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            name: `خصم على ${name}`,
                            description: `خصم ${discountPercentage}% على قسم ${name}`,
                            discountPercentage: parseFloat(discountPercentage),
                            startDate: new Date().toISOString().split('T')[0],
                            endDate: discountEndDate,
                            isActive: true
                        })
                    });
                } else {
                    // Create new discount
                    await apiRequest('/Discount', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: `خصم على ${name}`,
                            description: `خصم ${discountPercentage}% على قسم ${name}`,
                            discountPercentage: parseFloat(discountPercentage),
                            startDate: new Date().toISOString().split('T')[0],
                            endDate: discountEndDate,
                            categoryId: parseInt(categoryId),
                            isActive: true
                        })
                    });
                }
            }
        } else {
            response = await apiRequest('/categories', {
                method: 'POST',
                body: formData
            });
        }
        
        // إغلاق النافذة وإعادة التحميل
        closeModal('categoryModal');
        showNotification(isEdit ? 'تم تحديث القسم بنجاح' : 'تمت إضافة القسم بنجاح');
        loadCategories();
    } catch (error) {
        console.error('Error saving category:', error);
        showNotification(error.message || 'فشل حفظ القسم', 'danger');
    }
}


// Add this function to test category discount calculation
async function testCategoryDiscountCalculation() {
    try {
        // Test a specific category ID
        const categoryId = 1; // Change to a category ID that should have discounts
        const category = await apiRequest(`/categories/${categoryId}`);
        
        console.log('=== CATEGORY DISCOUNT DEBUG INFO ===');
        console.log('Category:', category);
        console.log('Category Name:', category.name);
        console.log('Category Discount:', category.discount);
        
        if (category.discount) {
            console.log('Discount Percentage:', category.discount.discountPercentage);
            console.log('Discount Start:', category.discount.startDate);
            console.log('Discount End:', category.discount.endDate);
            console.log('Discount Active:', category.discount.isActive);
            
            const now = new Date();
            const startDate = new Date(category.discount.startDate);
            const endDate = new Date(category.discount.endDate);
            
            console.log('Current Date:', now);
            console.log('Is Discount Active?', now >= startDate && now <= endDate);
        }
        
        // Test products in this category
        const products = await apiRequest(`/products?categoryId=${categoryId}`);
        console.log('Products in this category:', products.length);
        
        products.forEach(product => {
            console.log(`Product: ${product.name}, Price: ${product.price}, Discounted: ${product.discountedPrice}`);
        });
    } catch (error) {
        console.error('Category discount test failed:', error);
    }
}

// Call this function from the browser console when debugging
window.testCategoryDiscountCalculation = testCategoryDiscountCalculation;



    // Delete category
    async function deleteCategory(categoryId) {
        if (!confirm('هل أنت متأكد من حذف هذا القسم؟')) {
            return;
        }
        
        try {
            await apiRequest(`/categories/${categoryId}`, {
                method: 'DELETE'
            });
            
            showNotification('تم حذف القسم بنجاح');
            loadCategories();
        } catch (error) {
            console.error('Error deleting category:', error);
            showNotification(error.message || 'فشل حذف القسم', 'danger');
        }
    }
    
    // Load discounts
    // Load discounts
async function loadDiscounts() {
    try {
        const search = document.getElementById('discountSearch').value;
        const type = document.getElementById('discountTypeFilter').value;
        const active = document.getElementById('discountStatusFilter').value;
        
        let url = '/Discount?';  // Changed from '/discounts?' to '/Discount?'
        if (search) url += `search=${search}&`;
        if (type) url += `type=${type}&`;
        if (active) url += `active=${active}&`;
        
        const discounts = await apiRequest(url);
        
        const tbody = document.getElementById('discountsTable');
        tbody.innerHTML = '';
        
        if (discounts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">لا توجد خصومات</td></tr>';
            return;
        }
        
        discounts.forEach(discount => {
            const tr = document.createElement('tr');
            
            const statusClass = discount.isActive ? 'active' : 'inactive';
            const typeText = discount.productId ? 'خصم على منتج' : 'خصم على قسم';
            const targetName = discount.productName || discount.categoryName || '-';
            
            tr.innerHTML = `
                <td>${discount.name}</td>
                <td>${typeText}</td>
                <td>${targetName}</td>
                <td>${discount.discountPercentage}%</td>
                <td>${formatDate(discount.startDate)}</td>
                <td>${formatDate(discount.endDate)}</td>
                <td><span class="status-badge ${statusClass}">${discount.isActive ? 'نشط' : 'غير نشط'}</span></td>
                <td>
                    <button class="btn btn-sm btn-primary me-1 edit-discount-btn" data-id="${discount.id}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-discount-btn" data-id="${discount.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(tr);
        });
        
        // Add event listeners to edit and delete buttons
        document.querySelectorAll('.edit-discount-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const discountId = this.getAttribute('data-id');
                openDiscountModal(discountId);
            });
        });
        
        document.querySelectorAll('.delete-discount-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const discountId = this.getAttribute('data-id');
                deleteDiscount(discountId);
            });
        });
    } catch (error) {
        console.error('Error loading discounts:', error);
        document.getElementById('discountsTable').innerHTML = '<tr><td colspan="8" class="text-center text-danger">فشل تحميل الخصومات</td></tr>';
    }
}
    
    // Load products for discount dropdown
    async function loadProductsForDiscount() {
        try {
            const products = await apiRequest('/products?status=Active');
            
            const select = document.getElementById('discountProduct');
            select.innerHTML = '<option value="">اختر المنتج</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading products for discount:', error);
        }
    }
    
    // Load categories for discount dropdown
    async function loadCategoriesForDiscount() {
        try {
            const categories = await apiRequest('/categories');
            
            const select = document.getElementById('discountCategory');
            select.innerHTML = '<option value="">اختر القسم</option>';
            
            function addCategoryOptions(categories, level = 0) {
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = '  '.repeat(level) + category.name;
                    select.appendChild(option);
                    
                    // Add subcategories
                    if (category.subCategories && category.subCategories.length > 0) {
                        addCategoryOptions(category.subCategories, level + 1);
                    }
                });
            }
            
            addCategoryOptions(categories);
        } catch (error) {
            console.error('Error loading categories for discount:', error);
        }
    }
    
    // Open discount modal
    // Open discount modal
async function openDiscountModal(discountId = null) {
    const modal = new bootstrap.Modal(document.getElementById('discountModal'));
    const modalTitle = document.getElementById('discountModalTitle');
    const form = document.getElementById('discountForm');
    
    // Reset form
    form.reset();
    document.getElementById('discountProductField').style.display = 'none';
    document.getElementById('discountCategoryField').style.display = 'none';
    
    // Load products and categories for dropdowns
    loadProductsForDiscount();
    loadCategoriesForDiscount();
    
    if (discountId) {
        // Edit existing discount
        modalTitle.textContent = 'تعديل الخصم';
        
        try {
            const discount = await apiRequest(`/Discount/${discountId}`);  // Changed from '/discounts/'
            
            document.getElementById('discountId').value = discount.id;
            document.getElementById('discountName').value = discount.name;
            document.getElementById('discountDescription').value = discount.description || '';
            document.getElementById('discountType').value = discount.productId ? 'product' : 'category';
            document.getElementById('discountPercentage').value = discount.discountPercentage;
            document.getElementById('discountActive').value = discount.isActive.toString();
            document.getElementById('discountStartDate').value = formatDateForInput(discount.startDate);
            document.getElementById('discountEndDate').value = formatDateForInput(discount.endDate);
            
            // Show appropriate field based on discount type
            if (discount.productId) {
                document.getElementById('discountProductField').style.display = 'block';
                document.getElementById('discountProduct').value = discount.productId;
            } else if (discount.categoryId) {
                document.getElementById('discountCategoryField').style.display = 'block';
                document.getElementById('discountCategory').value = discount.categoryId;
            }
        } catch (error) {
            console.error('Error loading discount:', error);
            showNotification('فشل تحميل بيانات الخصم', 'danger');
            return;
        }
    } else {
        // Add new discount
        modalTitle.textContent = 'إضافة خصم جديد';
        document.getElementById('discountId').value = '';
        
        // Set default dates
        const today = new Date();
        const nextMonth = new Date();
        nextMonth.setMonth(today.getMonth() + 1);
        
        document.getElementById('discountStartDate').value = formatDateForInput(today);
        document.getElementById('discountEndDate').value = formatDateForInput(nextMonth);
    }
    
    modal.show();
}
    
    // Save discount
    // Save discount
async function saveDiscount() {
    const discountId = document.getElementById('discountId').value;
    const isEdit = !!discountId;
    
    const name = document.getElementById('discountName').value;
    const description = document.getElementById('discountDescription').value;
    const type = document.getElementById('discountType').value;
    const productId = document.getElementById('discountProduct').value || null;
    const categoryId = document.getElementById('discountCategory').value || null;
    const percentage = parseFloat(document.getElementById('discountPercentage').value);
    const isActive = document.getElementById('discountActive').value === 'true';
    const startDate = document.getElementById('discountStartDate').value;
    const endDate = document.getElementById('discountEndDate').value;
    
    // Validate form
    if (!name || !type || isNaN(percentage) || !startDate || !endDate) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'warning');
        return;
    }
    
    if (type === 'product' && !productId) {
        showNotification('يرجى اختيار منتج', 'warning');
        return;
    }
    
    if (type === 'category' && !categoryId) {
        showNotification('يرجى اختيار قسم', 'warning');
        return;
    }
    
    if (new Date(startDate) >= new Date(endDate)) {
        showNotification('تاريخ البدء يجب أن يكون قبل تاريخ الانتهاء', 'warning');
        return;
    }
    
    try {
        const discountData = {
            name: name,
            description: description,
            discountPercentage: percentage,
            startDate: startDate,
            endDate: endDate,
            isActive: isActive
        };
        
        if (type === 'product') {
            discountData.productId = parseInt(productId);
        } else if (type === 'category') {
            discountData.categoryId = parseInt(categoryId);
        }
        
        let response;
        if (isEdit) {
            response = await apiRequest(`/Discount/${discountId}`, {  // Changed from '/discounts/'
                method: 'PUT',
                body: JSON.stringify(discountData)
            });
        } else {
            response = await apiRequest('/Discount', {  // Changed from '/discounts'
                method: 'POST',
                body: JSON.stringify(discountData)
            });
        }
        
        // Close modal and fix focus issue
        closeModal('discountModal');
        
        // Show notification
        showNotification(isEdit ? 'تم تحديث الخصم بنجاح' : 'تمت إضافة الخصم بنجاح');
        
        // Reload discounts
        loadDiscounts();
    } catch (error) {
        console.error('Error saving discount:', error);
        showNotification(error.message || 'فشل حفظ الخصم', 'danger');
    }
}
    
    // Delete discount
    // Delete discount
async function deleteDiscount(discountId) {
    if (!confirm('هل أنت متأكد من حذف هذا الخصم؟')) {
        return;
    }
    
    try {
        await apiRequest(`/Discount/${discountId}`, {  // Changed from '/discounts/'
            method: 'DELETE'
        });
        
        showNotification('تم حذف الخصم بنجاح');
        loadDiscounts();
    } catch (error) {
        console.error('Error deleting discount:', error);
        showNotification(error.message || 'فشل حذف الخصم', 'danger');
    }
}
    
    // Load orders
    async function loadOrders() {
        try {
            const search = document.getElementById('orderSearch').value;
            const status = document.getElementById('orderStatusFilter').value;
            const dateFilter = document.getElementById('orderDateFilter').value;
            
            let url = '/orders/all?';
            if (search) url += `search=${search}&`;
            if (status) url += `status=${status}&`;
            
            // Add date filter
            if (dateFilter) {
                const now = new Date();
                let startDate;
                
                switch (dateFilter) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'week':
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - now.getDay());
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                }
                
                if (startDate) {
                    url += `startDate=${formatDate(startDate)}&`;
                }
            }
            
            const orders = await apiRequest(url);
            
            const tbody = document.getElementById('ordersTable');
            tbody.innerHTML = '';
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">لا توجد طلبات</td></tr>';
                return;
            }
            
            orders.forEach(order => {
                const tr = document.createElement('tr');
                
                const statusClass = order.status.toLowerCase();
                
                // Calculate total discount
                let totalDiscount = 0;
                if (order.productDiscountAmount) {
                    totalDiscount += order.productDiscountAmount;
                }
                if (order.couponDiscountAmount) {
                    totalDiscount += order.couponDiscountAmount;
                }
                
                tr.innerHTML = `
                    <td>${order.orderNumber}</td>
                    <td>${order.userName}</td>
                    <td>${formatDate(order.orderDate)}</td>
                    <td>${formatPrice(order.orderTotal)}</td>
                    <td>${totalDiscount > 0 ? formatPrice(totalDiscount) : '-'}</td>
                    <td>${formatPrice(order.finalAmount || order.orderTotal)}</td>
                    <td><span class="status-badge ${statusClass}">${getStatusText(order.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary view-order-btn" data-id="${order.id}">
                            <i class="bi bi-eye"></i>
                        </button>
                        ${order.status === 'Pending' ? `
                            <button class="btn btn-sm btn-success update-order-status-btn" data-id="${order.id}" data-status="Processing">
                                <i class="bi bi-check-circle"></i>
                            </button>
                        ` : ''}
                        ${order.status === 'Processing' ? `
                            <button class="btn btn-sm btn-warning update-order-status-btn" data-id="${order.id}" data-status="Shipped">
                                <i class="bi bi-truck"></i>
                            </button>
                        ` : ''}
                        ${order.status === 'Shipped' ? `
                            <button class="btn btn-sm btn-success update-order-status-btn" data-id="${order.id}" data-status="Delivered">
                                <i class="bi bi-check-all"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Add event listeners to view and update status buttons
            document.querySelectorAll('.view-order-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-id');
                    viewOrderDetails(orderId);
                });
            });
            
            document.querySelectorAll('.update-order-status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-id');
                    const status = this.getAttribute('data-status');
                    updateOrderStatus(orderId, status);
                });
            });
        } catch (error) {
            console.error('Error loading orders:', error);
            document.getElementById('ordersTable').innerHTML = '<tr><td colspan="8" class="text-center text-danger">فشل تحميل الطلبات</td></tr>';
        }
    }
    
    // View order details
    async function viewOrderDetails(orderId) {
        try {
            const order = await apiRequest(`/orders/${orderId}`);
            
            const content = document.getElementById('orderDetailsContent');
            
            let orderItemsHtml = '';
            order.orderItems.forEach(item => {
                const discountedPrice = item.discountedUnitPrice || item.unitPrice;
                const savings = item.unitPrice - discountedPrice;
                
                orderItemsHtml += `
                    <tr>
                        <td>${item.productName}</td>
                        <td>${item.quantity}</td>
                        <td>${formatPrice(item.unitPrice)}</td>
                        <td>${formatPrice(discountedPrice)}</td>
                        <td>${savings > 0 ? formatPrice(savings) : '-'}</td>
                        <td>${formatPrice(item.totalPrice)}</td>
                    </tr>
                `;
            });
            
            content.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>معلومات الطلب</h6>
                        <p><strong>رقم الطلب:</strong> ${order.orderNumber}</p>
                        <p><strong>التاريخ:</strong> ${formatDate(order.orderDate)}</p>
                        <p><strong>الحالة:</strong> <span class="status-badge ${order.status.toLowerCase()}">${getStatusText(order.status)}</span></p>
                        <p><strong>طريقة الدفع:</strong> ${getPaymentMethodText(order.paymentMethod)}</p>
                        ${order.shippedDate ? `<p><strong>تاريخ الشحن:</strong> ${formatDate(order.shippedDate)}</p>` : ''}
                        ${order.deliveredDate ? `<p><strong>تاريخ التسليم:</strong> ${formatDate(order.deliveredDate)}</p>` : ''}
                    </div>
                    <div class="col-md-6">
                        <h6>معلومات العميل</h6>
                        <p><strong>الاسم:</strong> ${order.userName}</p>
                        <p><strong>البريد الإلكتروني:</strong> ${order.userId}</p>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>عنوان الشحن</h6>
                        <p><strong>الاسم:</strong> ${order.shippingAddress.fullName}</p>
                        <p><strong>الهاتف:</strong> ${order.shippingAddress.phoneNumber}</p>
                        <p><strong>العنوان:</strong> ${order.shippingAddress.street}, ${order.shippingAddress.city}, ${order.shippingAddress.region}, ${order.shippingAddress.postalCode}, ${order.shippingAddress.country}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>ملخص الطلب</h6>
                        <p><strong>الإجمالي:</strong> ${formatPrice(order.subtotal || order.orderTotal)}</p>
                        ${order.productDiscountAmount ? `<p><strong>خصم المنتجات:</strong> ${formatPrice(order.productDiscountAmount)}</p>` : ''}
                        ${order.couponDiscountAmount ? `<p><strong>خصم الكوبون:</strong> ${formatPrice(order.couponDiscountAmount)}</p>` : ''}
                        <p><strong>الإجمالي النهائي:</strong> ${formatPrice(order.finalAmount || order.orderTotal)}</p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h6>منتجات الطلب</h6>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>الكمية</th>
                                    <th>السعر الأصلي</th>
                                    <th>السعر بعد الخصم</th>
                                    <th>الوفورات</th>
                                    <th>الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${orderItemsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                ${order.shippingNotes ? `
                    <div class="mb-4">
                        <h6>ملاحظات الشحن</h6>
                        <p>${order.shippingNotes}</p>
                    </div>
                ` : ''}
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();
        } catch (error) {
            console.error('Error loading order details:', error);
            // FIXED: Better error message
            showNotification('الطلب غير موجود أو تم حذفه', 'danger');
        }
    }
    
    // Update order status
    async function updateOrderStatus(orderId, status) {
        try {
            await apiRequest(`/orders/${orderId}/status`, {
                method: 'PUT',
                body: JSON.stringify({ status: status })
            });
            
            showNotification('تم تحديث حالة الطلب بنجاح');
            loadOrders();
        } catch (error) {
            console.error('Error updating order status:', error);
            showNotification(error.message || 'فشل تحديث حالة الطلب', 'danger');
        }
    }
    
    // Load coupons
    async function loadCoupons() {
        try {
            const coupons = await apiRequest('/coupons');
            
            const tbody = document.getElementById('couponsTable');
            tbody.innerHTML = '';
            
            if (coupons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد كوبونات</td></tr>';
                return;
            }
            
            coupons.forEach(coupon => {
                const tr = document.createElement('tr');
                
                const statusClass = coupon.isActive ? 'active' : 'inactive';
                
                tr.innerHTML = `
                    <td>${coupon.couponCode}</td>
                    <td>${coupon.discountPercentage}%</td>
                    <td>${formatDate(coupon.expiryDate)}</td>
                    <td>${coupon.usageLimit || 'غير محدود'}</td>
                    <td>${coupon.usedCount} / ${coupon.usageLimit || '∞'}</td>
                    <td><span class="status-badge ${statusClass}">${coupon.isActive ? 'نشط' : 'غير نشط'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1 edit-coupon-btn" data-id="${coupon.id}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-coupon-btn" data-id="${coupon.id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-coupon-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const couponId = this.getAttribute('data-id');
                    openCouponModal(couponId);
                });
            });
            
            document.querySelectorAll('.delete-coupon-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const couponId = this.getAttribute('data-id');
                    deleteCoupon(couponId);
                });
            });
        } catch (error) {
            console.error('Error loading coupons:', error);
            document.getElementById('couponsTable').innerHTML = '<tr><td colspan="7" class="text-center text-danger">فشل تحميل الكوبونات</td></tr>';
        }
    }
    
    // Open coupon modal
    function openCouponModal(couponId = null) {
        const modal = new bootstrap.Modal(document.getElementById('couponModal'));
        const modalTitle = document.getElementById('couponModalTitle');
        const form = document.getElementById('couponForm');
        
        // Reset form
        form.reset();
        
        if (couponId) {
            // Edit existing coupon
            modalTitle.textContent = 'تعديل الكوبون';
            
            // Load coupon data
            apiRequest(`/coupons/${couponId}`)
                .then(coupon => {
                    document.getElementById('couponId').value = coupon.id;
                    document.getElementById('couponCode').value = coupon.couponCode;
                    document.getElementById('couponDiscount').value = coupon.discountPercentage;
                    document.getElementById('couponExpiry').value = formatDateForInput(coupon.expiryDate);
                    document.getElementById('couponUsageLimit').value = coupon.usageLimit || '';
                    document.getElementById('couponMinAmount').value = coupon.minimumOrderAmount || '';
                    document.getElementById('couponActive').checked = coupon.isActive;
                })
                .catch(error => {
                    console.error('Error loading coupon:', error);
                    showNotification('فشل تحميل بيانات الكوبون', 'danger');
                });
        } else {
            // Add new coupon
            modalTitle.textContent = 'إضافة كوبون جديد';
            document.getElementById('couponId').value = '';
            
            // Set default expiry date to 30 days from now
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + 30);
            document.getElementById('couponExpiry').value = formatDateForInput(expiryDate);
        }
        
        modal.show();
    }
    
    // Save coupon
    async function saveCoupon() {
        const couponId = document.getElementById('couponId').value;
        const isEdit = !!couponId;
        
        const code = document.getElementById('couponCode').value;
        const discount = parseFloat(document.getElementById('couponDiscount').value);
        const expiry = document.getElementById('couponExpiry').value;
        const usageLimit = document.getElementById('couponUsageLimit').value ? parseInt(document.getElementById('couponUsageLimit').value) : null;
        const minAmount = document.getElementById('couponMinAmount').value ? parseFloat(document.getElementById('couponMinAmount').value) : null;
        const isActive = document.getElementById('couponActive').checked;
        
        // Validate form
        if (!code || isNaN(discount) || !expiry) {
            showNotification('يرجى ملء جميع الحقول المطلوبة', 'warning');
            return;
        }
        
        try {
            let response;
            if (isEdit) {
                response = await apiRequest(`/coupons/${couponId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        couponCode: code,
                        discountPercentage: discount,
                        expiryDate: expiry,
                        usageLimit: usageLimit,
                        minimumOrderAmount: minAmount,
                        isActive: isActive
                    })
                });
            } else {
                response = await apiRequest('/coupons', {
                    method: 'POST',
                    body: JSON.stringify({
                        couponCode: code,
                        discountPercentage: discount,
                        expiryDate: expiry,
                        usageLimit: usageLimit,
                        minimumOrderAmount: minAmount
                    })
                });
            }
            
            // Close modal and fix focus issue
            const modal = bootstrap.Modal.getInstance(document.getElementById('couponModal'));
            modal.hide();
            
            // Fix ARIA hidden warning
            document.getElementById('couponModal').querySelectorAll('button, input, select, textarea').forEach(el => {
                el.blur();
            });
            
            // Show notification
            showNotification(isEdit ? 'تم تحديث الكوبون بنجاح' : 'تمت إضافة الكوبون بنجاح');
            
            // Reload coupons
            loadCoupons();
        } catch (error) {
            console.error('Error saving coupon:', error);
            showNotification(error.message || 'فشل حفظ الكوبون', 'danger');
        }
    }
    
    // Delete coupon
    async function deleteCoupon(couponId) {
        if (!confirm('هل أنت متأكد من حذف هذا الكوبون؟')) {
            return;
        }
        
        try {
            await apiRequest(`/coupons/${couponId}`, {
                method: 'DELETE'
            });
            
            showNotification('تم حذف الكوبون بنجاح');
            loadCoupons();
        } catch (error) {
            console.error('Error deleting coupon:', error);
            showNotification(error.message || 'فشل حذف الكوبون', 'danger');
        }
    }
    
    // Load users
    async function loadUsers() {
        try {
            const search = document.getElementById('userSearch').value;
            const role = document.getElementById('userRoleFilter').value;
            const dateFilter = document.getElementById('userDateFilter').value;
            
            let url = '/users?';
            if (search) url += `search=${search}&`;
            if (role) url += `role=${role}&`;
            
            // Add date filter
            if (dateFilter) {
                const now = new Date();
                let startDate;
                
                switch (dateFilter) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'week':
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - now.getDay());
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                }
                
                if (startDate) {
                    url += `startDate=${formatDate(startDate)}&`;
                }
            }
            
            const users = await apiRequest(url);
            
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد مستخدمين</td></tr>';
                return;
            }
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${user.email}</td>
                    <td>${user.phone || '-'}</td>
                    <td>${user.role === 'Admin' ? 'مدير' : 'عميل'}</td>
                    <td>${formatDate(user.createdAt)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-user-btn" data-id="${user.id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    deleteUser(userId);
                });
            });
        } catch (error) {
            console.error('Error loading users:', error);
            document.getElementById('usersTable').innerHTML = '<tr><td colspan="6" class="text-center text-danger">فشل تحميل المستخدمين</td></tr>';
        }
    }
    
    // Delete user
    async function deleteUser(userId) {
        if (!confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
            return;
        }
        
        try {
            await apiRequest(`/users/${userId}`, {
                method: 'DELETE'
            });
            
            showNotification('تم حذف المستخدم بنجاح');
            loadUsers();
        } catch (error) {
            console.error('Error deleting user:', error);
            showNotification(error.message || 'فشل حذف المستخدم', 'danger');
        }
    }
    
    // Initialize reports
    function initializeReports() {
        // Set default dates for sales report
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        
        document.getElementById('salesStartDate').value = formatDateForInput(startOfMonth);
        document.getElementById('salesEndDate').value = formatDateForInput(endOfMonth);
    }
    
    // Generate sales report
    async function generateSalesReport() {
        try {
            const startDate = document.getElementById('salesStartDate').value;
            const endDate = document.getElementById('salesEndDate').value;
            
            if (!startDate || !endDate) {
                showNotification('يرجى تحديد تاريخ البداية والنهاية', 'warning');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('تاريخ البداية يجب أن يكون قبل تاريخ النهاية', 'warning');
                return;
            }
            
            // FIXED: Use ISO date format
            const report = await apiRequest(`/admin/sales-report?startDate=${new Date(startDate).toISOString().split('T')[0]}&endDate=${new Date(endDate).toISOString().split('T')[0]}`);
            
            // Update report content
            document.getElementById('reportTotalOrders').textContent = report.totalOrders;
            document.getElementById('reportTotalRevenue').textContent = formatPrice(report.totalRevenue);
            document.getElementById('reportTotalCustomers').textContent = report.totalCustomers;
            document.getElementById('reportTotalProducts').textContent = report.totalProductsSold;
            
            // Show report content
            document.getElementById('salesReportContent').style.display = 'block';
            
            // Load category sales chart
            const categoryCtx = document.getElementById('categorySalesChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (categorySalesChart) {
                categorySalesChart.destroy();
            }
            
            categorySalesChart = new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: report.categorySales.map(c => c.categoryName),
                    datasets: [{
                        label: 'الإيرادات',
                        data: report.categorySales.map(c => c.revenue),
                        backgroundColor: 'rgba(26, 54, 93, 0.7)',
                        borderColor: 'rgba(26, 54, 93, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatPrice(value);
                                }
                            }
                        }
                    }
                }
            });
            
            // Load daily sales chart
            const dailyCtx = document.getElementById('dailySalesChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (dailySalesChart) {
                dailySalesChart.destroy();
            }
            
            dailySalesChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: report.dailySales.map(d => formatDateForChart(d.date)),
                    datasets: [{
                        label: 'المبيعات',
                        data: report.dailySales.map(d => d.revenue),
                        backgroundColor: 'rgba(49, 151, 149, 0.1)',
                        borderColor: 'rgba(49, 151, 149, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatPrice(value);
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error generating sales report:', error);
            showNotification('فشل إنشاء تقرير المبيعات', 'danger');
        }
    }
    
    // Generate inventory report
    async function generateInventoryReport() {
        try {
            const report = await apiRequest('/admin/inventory-report');
            
            // Update report content
            document.getElementById('inventoryTotalProducts').textContent = report.totalProducts;
            document.getElementById('inventoryOutOfStock').textContent = report.outOfStockProducts;
            document.getElementById('inventoryLowStock').textContent = report.lowStockProducts;
            
            // Show report content
            document.getElementById('inventoryReportContent').style.display = 'block';
            
            // Load low stock products
            const tbody = document.getElementById('lowStockTable');
            tbody.innerHTML = '';
            
            if (report.lowStockItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center">لا توجد منتجات منخفضة المخزون</td></tr>';
                return;
            }
            
            report.lowStockItems.forEach(item => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${item.productName}</td>
                    <td>${item.currentStock}</td>
                    <td>${item.minimumThreshold}</td>
                `;
                
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error generating inventory report:', error);
            showNotification('فشل إنشاء تقرير المخزون', 'danger');
        }
    }
    
    // Generate customer report
    async function generateCustomerReport() {
        try {
            const report = await apiRequest('/admin/customer-report');
            
            // Update report content
            document.getElementById('customerTotalCustomers').textContent = report.totalCustomers;
            document.getElementById('customerNewCustomers').textContent = report.newCustomersThisMonth;
            document.getElementById('customerActiveCustomers').textContent = report.activeCustomers;
            
            // Show report content
            document.getElementById('customerReportContent').style.display = 'block';
            
            // Load top customers
            const tbody = document.getElementById('topCustomersTable');
            tbody.innerHTML = '';
            
            if (report.topCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center">لا توجد بيانات</td></tr>';
                return;
            }
            
            report.topCustomers.forEach(customer => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${customer.customerName}</td>
                    <td>${customer.ordersCount}</td>
                    <td>${formatPrice(customer.totalSpent)}</td>
                `;
                
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error generating customer report:', error);
            showNotification('فشل إنشاء تقرير العملاء', 'danger');
        }
    }
    
    // Helper functions
    function formatPrice(price) {
        return new Intl.NumberFormat('ar-EG', {
            style: 'currency',
            currency: 'EGP',
            minimumFractionDigits: 2
        }).format(price);
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-EG');
    }
    
    function formatDateForInput(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    function formatDateForChart(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' });
    }
    
    function getStatusText(status) {
        const statusMap = {
            'Pending': 'قيد الانتظار',
            'Processing': 'قيد المعالجة',
            'Shipped': 'تم الشحن',
            'Delivered': 'تم التسليم',
            'Cancelled': 'ملغي'
        };
        return statusMap[status] || status;
    }
    
    function getPaymentMethodText(method) {
        const methodMap = {
            'CashOnDelivery': 'الدفع عند الاستلام',
            'CreditCard': 'بطاقة ائتمان',
            'Wallet': 'محفظة إلكترونية'
        };
        return methodMap[method] || method;
    }
});
 </script>
</body>
</html>